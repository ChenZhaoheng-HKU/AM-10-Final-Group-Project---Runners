---
title: "Data Visualization: Final Project"
author: "Your name goes here"
date: "`r Sys.Date()`"
output: 
    html_document:
      number_sections: true
      highlight: zenburn
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: false
      fontsize: 10pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(vroom)
library(janitor)
library(skimr)
library(vroom)
library(mice) 
library(VIM)
library(stringr)
library(maps)
library(rworldmap)
library(sf)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
# Read the CSV files
results <- read.csv("results.csv", stringsAsFactors = FALSE)
athlete_events <- read.csv("athlete_events.csv", stringsAsFactors = FALSE)
```

```{r}
# Modify the two datasets to prepare for the later merge
athlete_events <- athlete_events %>%
  
  distinct(Name, Year, .keep_all = TRUE) %>%
  
  mutate(NameSplit = str_split(Name, " "),
         last_name = map_chr(NameSplit, function(x) x[length(x)]),
         first_name = map_chr(NameSplit, function(x) paste(x[1], collapse = " "))) %>%
  
  filter(!is.na(Medal), Sport %in% c("Athletics")) %>%
  
  mutate(Medal = case_when(
    Medal == "Gold" ~ "G",
    Medal == "Silver" ~ "S",
    Medal == "Bronze" ~ "B",
    TRUE ~ Medal
    )) %>%
  
  select(-last_name, -NameSplit)

results <- results %>%
  mutate(NameSplit = str_split(Name, " "),
         last_name = map_chr(NameSplit, function(x) x[length(x)]),
         first_name = map_chr(NameSplit, function(x) paste(x[1:(length(x)-1)], collapse = " "))) %>%
  
  select(-NameSplit)

# Convert 'Name' column in both data frames to lowercase
results$first_name<- tolower(results$first_name)
athlete_events$first_name <- tolower(athlete_events$first_name)
```

```{r}
# Merge the data frames on 'Name' 'Medal' and 'Year'
combined_df <- results %>%
  left_join(athlete_events, by = c("first_name", "Medal", "Year")) %>%
  filter(!is.na(ID))
```

```{r}
# 2. Convert 'Results' to Time Format
convert_time <- function(time_str) {
  # Split the time string by ':'
  parts <- strsplit(time_str, ":")[[1]]
  # Convert to time
  if (length(parts) == 3) {
    return(as.numeric(parts[[1]]) * 3600 + as.numeric(parts[[2]]) * 60 + as.numeric(parts[[3]]))
  }
  else if (length(parts) == 2) {
    return(as.numeric(parts[[1]]) * 60 + as.numeric(parts[[2]]))
  } else {
    return(as.numeric(parts[[1]]))
  }
}

# 3. Extract Distance from 'Event'
extract_distance <- function(event_str) {
  # If the event contains "marathon", return 42195
  if (grepl("marathon", tolower(event_str))) {
    return(42195)
  }
  # Otherwise, extract the first number from the string
  as.numeric(stringr::str_extract(event_str, "\\d+"))
}
```

```{r}
running_events <- combined_df %>% 
  filter(grepl("M Men|M Women", Event.x), 
         !is.na(ID)) # Adjust the pattern as needed

running_events$Time <- sapply(running_events$Result, convert_time)
running_events$Distance <- sapply(running_events$Event.x, extract_distance)

# Display the first few rows of the cleaned data
head(running_events)
```

```{r}
# Preparing for plotting
running_events$Height_Category <- cut(running_events$Height, 
                                      breaks = seq(from = min(running_events$Height, na.rm = TRUE), 
                                                   to = max(running_events$Height, na.rm = TRUE), 
                                                   by = 5), 
                                      include.lowest = TRUE)

running_events<- running_events %>%
  drop_na(Height_Category) %>%
  filter(Height_Category != "NA") # Replace NA with actual NA representation in data

height_breaks <- seq(from = min(running_events$Height, na.rm = TRUE), 
                     to = max(running_events$Height, na.rm = TRUE), 
                     by = 5) # Adjust the 'by' parameter as needed
height_labels <- paste(head(height_breaks, -1), tail(height_breaks, -1), sep = "-")

# Now use these labels when you create the 'Height_Category'
running_events$Height_Category <- cut(running_events$Height, 
                                      breaks = height_breaks, 
                                      labels = height_labels, 
                                      include.lowest = TRUE)

y_breaks <- seq(0, 7000, by = 1500)
  
ggplot(running_events, aes(x = Height_Category, y = Distance, fill = Gender)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  scale_fill_brewer(palette = "Pastel1") +
  theme_minimal() +
  labs(x = "Height Category (cm)", y = "Average Distance (m)",
       title = "Taller athletes tend to run shorter distances in Olympic Events") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1),
        legend.title = element_blank()) +
  geom_text(aes(label = round(..y.., 0)),  # Round to the nearest whole number
            position = position_dodge(width = 0.9),
            stat = "summary", 
            vjust = -0.5, 
            fun = "mean") +
  scale_y_continuous(breaks = y_breaks, labels = as.character(y_breaks)) +
  coord_cartesian(ylim = c(0, max(running_events$Distance, na.rm = TRUE) * 1.1))

```

```{r}
running_events$Weight_Category <- cut(running_events$Weight, 
              breaks = seq(from = min(running_events$Weight, 
                                      na.rm = TRUE), 
to = max(running_events$Weight, na.rm = TRUE), 
                              by = 5),  # Adjust the 'by' parameter as needed
                include.lowest = TRUE)


weight_breaks <- seq(from = min(running_events$Weight, na.rm = TRUE), 
                     to = max(running_events$Weight, na.rm = TRUE), 
                     by = 8) # Adjust the 'by' parameter as needed
weight_labels <- paste(head(weight_breaks, -1), tail(weight_breaks, -1), sep = "-")


# Now use these labels when you create the 'Weight_Category'
running_events$Weight_Category <- cut(running_events$Weight, 
                                      breaks = weight_breaks, 
                                      labels = weight_labels, 
                                      include.lowest = TRUE)
running_events <- running_events %>%
  filter(!is.na(Weight_Category))

y_breaks <- seq(0, max(running_events$Distance, na.rm = TRUE), by = 1500)

ggplot(running_events, aes(x = Weight_Category, y = Distance, fill = Gender)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") + # Use 'position = dodge' to group by Gender
  scale_fill_brewer(palette = "Pastel1") + # Choose a palette that offers good contrast between genders
  theme_minimal() +
  labs(x = "Weight Category (kg )", y = "Average Distance (m)",
       title = "Lighter Athletes Tend to Run Longer Distances in Olympic Events") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1),
        legend.title = element_blank()) + # Hide the legend title if you want
  geom_text(aes(label = round(..y.., 0)), 
            position = position_dodge(width = 0.9), # Adjust text labels to match the dodge width
            stat = "summary", 
            vjust = -0.5, 
            fun = "mean") +
 scale_y_continuous(breaks = y_breaks, labels = as.character(y_breaks)) +
  coord_cartesian(ylim = c(0, max(running_events$Distance, na.rm = TRUE) * 1.1)) # Adjust Y-axis limit
```

## Geographical distribution

```{r}
medal_count <- results %>%
  mutate(Race_Type = ifelse(grepl("\\b(100M|200M|400M) (Men|Women)\\b", Event), "Short", 
                     ifelse(grepl("\\b(800M|1500M|5000M|10000M|Marathon) (Men|Women)\\b", Event), "Long", NA))) %>%
  
  filter(!is.na(Race_Type)) %>%
  
  group_by(Nationality, Race_Type) %>%
  
  summarise(Medal_count = n()) %>%
  
  pivot_wider(names_from = Race_Type, values_from = Medal_count, names_prefix = "Medal_count_") %>%
  
  replace_na(list(Medal_count_Short = 0, Medal_count_Long = 0)) %>%
  
  mutate(Medal_count_Total = Medal_count_Short + Medal_count_Long)

# Update the existing medal_count dataframe with percentage calculations
medal_count <- medal_count %>%
  mutate(
    medal_percent_short = ifelse(Medal_count_Total > 0, Medal_count_Short / Medal_count_Total * 100, 0),
    Medal_percent_Long = ifelse(Medal_count_Total > 0, Medal_count_Long / Medal_count_Total * 100, 0))

world_map <- getMap()
world_map_sf <- st_as_sf(world_map)
world_map_sf <- left_join(world_map_sf, medal_count, by = c("ISO_A3" = "Nationality"))

```

```{r}
# Assuming world_map_sf is already properly joined with medal_count
# Plot for short distance percentage
ggplot() +
  geom_sf(data = world_map_sf, aes(fill = medal_percent_short)) +
  scale_fill_continuous(low = "white", high = "red", na.value = "grey", label = scales::percent) +
  theme_minimal() +
  theme(panel.grid = element_blank(), legend.position = "bottom") +
  labs(fill = "Percentage of Total Medals", title = "Percentage of Short Distance Medals by Country") + 
  scale_fill_continuous(
  low = "white", 
  high = "red", 
  na.value = "grey", 
  labels = c("0%", "25%", "50%", "75%", "100%")
)


# Plot for long distance percentage
ggplot() +
  geom_sf(data = world_map_sf, aes(fill = Medal_percent_Long)) +
  scale_fill_continuous(low = "white", high = "red", na.value = "grey", label = scales::percent) +
  theme_minimal() +
  theme(panel.grid = element_blank(), legend.position = "bottom") +
  labs(fill = "Percentage of Total Medals", title = "Percentage of Long Distance Medals by Country") + 
  scale_fill_continuous(
  low = "white", 
  high = "red", 
  na.value = "grey", 
  labels = c("0%", "25%", "50%", "75%", "100%")
)

```

## Gender differences

```{r}
performance <- results %>%
  mutate(Race_Type = ifelse(grepl("\\b(100M|200M|400M) (Men|Women)\\b", Event), "Short", 
                     ifelse(grepl("\\b(800M|1500M|5000M|10000M|Marathon) (Men|Women)\\b", Event), "Long", NA))) %>%
  filter(!is.na(Race_Type), !Result %in% c("None"))

performance$Result <- gsub("h|-", ":", performance$Result)
performance$Time <- sapply(performance$Result, convert_time)
performance$Distance <- sapply(performance$Event, extract_distance)
performance$Distance <- factor(performance$Distance,
                               levels =  sort(unique(performance$Distance), decreasing = TRUE))
```

```{r}
# Difference
avg_times <- performance %>%
  filter(Year >= 1984) %>%
  group_by(Year, Gender, Race_Type) %>%
  summarise(avg_time = mean(Time, na.rm = TRUE)) %>%
  spread(Gender, avg_time) %>%
  mutate(diff_pct = abs(W - M) / M * 100) %>%
  gather(Gender, avg_time, M, W, factor_key=TRUE)

# Plot the differences
ggplot(avg_times, aes(x = Year, y = diff_pct, color = Race_Type)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  #facet_wrap(~ Race_Type, scales = "free_y") +
  labs(title = "% Difference in Average Time between Male and Female athletes",
       x = "Year", 
       y = "% Difference in Average Time", color = "Race Type") +
  theme_minimal()

```

# BMI and weight distribution overtime

```{r}
athlete_events$Event <- gsub(",", "", athlete_events$Event)

events_to_select <- c("100 metres", "200 metres", "800 metres", "1500 metres", "10000 metres", "Marathon")

selected_events <- athlete_events %>%
  filter(sapply(Event, function(x) any(sapply(events_to_select, function(y) grepl(y, x)))) &
         !grepl("Relay", Event) & 
         !grepl("Hurdles", Event) &
         !grepl("Steeplechase",Event) &
         Sex == "M") %>%
  mutate(BMI = Weight / (Height/100)^2)

selected_events$Distance <- sapply(selected_events$Event, extract_distance)
selected_events$Distance <- factor(selected_events$Distance)

avg_BMI_overtime <- selected_events %>%
  group_by(Year, Distance) %>%
  summarise(Avg_BMI = mean(BMI, na.rm = TRUE),
            Avg_Height = mean(Height),
            Avg_Weight = mean(Weight))

# Plot for weight <- ***Bjorn votes for this****
ggplot(data = avg_BMI_overtime, aes(x = Year, y = Avg_Weight, color = Distance)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(title = "Average Male Weight Over Time by Distance", x = "Year", y = "Average Weight") +
  theme_minimal()

# Plot for BMI
ggplot(data = avg_BMI_overtime, aes(x = Year, y = Avg_BMI, color = Distance)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(title = "Average Male BMI Over Time by Distance", x = "Year", y = "Average BMI") +
  theme_minimal()

```

```{r}
# Performance improved over time?
performance %>%
  filter(Distance %in% c(100, 200, 800, 1500, 10000, 42195) &
         Gender == "M" &
         Year != 1988 &
         Year != 1928) %>%
  group_by(Year, Distance) %>%
  summarise(avg_time = mean(Time, na.rm = TRUE)) %>%
  
  ggplot(aes(x = Year, y = avg_time, color = Distance)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_wrap(~Distance, scales = "free_y") +
  labs(title = "Average Male Performance Over Time by Distance", x = "Year", y = "Average Time") +
  theme_minimal() +
  
  #Modify theme elements
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        axis.text.y = element_text(size = 7),
        strip.text.x = element_text(size = 8),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        legend.position = "none") +
  
  #Add a border to each panel and customize the background of the facet labels
  theme(panel.border = element_rect(color = "black", fill = NA, size = 0.3)) +
  theme(strip.background = element_rect(fill = "gray", color = "black"))
```

```{r}
# % of improvement: male, overtime <- This one is useless
performance %>%
  filter(Distance %in% c(100, 200, 800, 1500, 10000, 42195) &
         Gender == "M" &
         Year != 1988 &
         Year != 1928) %>%
  group_by(Distance, Year) %>%
  summarise(avg_time = mean(Time, na.rm = TRUE)) %>%
  mutate(time_improvement = (lag(avg_time) - avg_time) / lag(avg_time) * 100) %>%
  
  ggplot(aes(x = Year, y = time_improvement, color = Distance)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(title = "Year-over-year Improvement Percentage in Average Male Performance by Distance",
       x = "Year", y = "Average Time Improvement (%)") +
  theme_minimal()
```

```{r}
# This is a test to see women BMI or Weight overtime, not meaningful
athlete_events$Event <- gsub(",", "", athlete_events$Event)

events_to_select <- c("100 metres", "200 metres", "800 metres", "1500 metres", "10000 metres", "Marathon")

selected_events <- athlete_events %>%
  filter(sapply(Event, function(x) any(sapply(events_to_select, function(y) grepl(y, x)))) &
         !grepl("Relay", Event) & 
         !grepl("Hurdles", Event) &
         !grepl("Steeplechase",Event) &
         Sex == "F" &
         Year >= 1984 ) %>%
  mutate(BMI = Weight / (Height/100)^2)

selected_events$Distance <- sapply(selected_events$Event, extract_distance)
selected_events$Distance <- factor(selected_events$Distance)

avg_BMI_overtime <- selected_events %>%
  group_by(Year, Distance) %>%
  summarise(Avg_BMI = mean(BMI, na.rm = TRUE),
            Avg_Height = mean(Height),
            Avg_Weight = mean(Weight))


ggplot(data = avg_BMI_overtime, aes(x = Year, y = Avg_Weight, color = Distance)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(title = "Average Female Weight Over Time by Distance", x = "Year", y = "Average BMI") +
  theme_minimal()
```
